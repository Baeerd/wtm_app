/*
 * File: app/view/TargetSelectDialog.js
 *
 * This file was generated by Sencha Architect version 3.0.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.3.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.3.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('SYSM.view.TargetSelectDialog', {
    extend: 'Ext.Container',
    alias: 'widget.targetSelectDialog',

    requires: [
        'Ext.Button',
        'Ext.field.Select',
        'Ext.field.Number',
        'Ext.dataview.List',
        'Ext.XTemplate',
        'Ext.plugin.ListPaging'
    ],

    config: {
        callback: 'function(){}',
        centered: true,
        cls: 'target_select_bg',
        height: '80%',
        id: 'targetSelectDialog',
        padding: '2%',
        width: '90%',
        hideOnMaskTap: true,
        modal: true,
        layout: {
            type: 'vbox',
            align: 'center'
        },
        items: [
            {
                xtype: 'container',
                width: '100%',
                layout: {
                    type: 'hbox',
                    pack: 'end'
                },
                items: [
                    {
                        xtype: 'button',
                        cls: [
                            'base_font_family',
                            'menu_view_bg'
                        ],
                        height: 32,
                        itemId: 'close',
                        ui: 'small',
                        width: 60,
                        text: '关闭'
                    }
                ]
            },
            {
                xtype: 'container',
                margin: '5 0',
                width: '100%',
                layout: 'hbox',
                items: [
                    {
                        xtype: 'container',
                        flex: 1,
                        margin: '0 1',
                        width: '32%',
                        layout: {
                            type: 'hbox',
                            align: 'center'
                        },
                        items: [
                            {
                                xtype: 'container',
                                cls: 'blue_font',
                                html: '库',
                                margin: '0 5'
                            },
                            {
                                xtype: 'container',
                                flex: 1,
                                cls: 'blue_border',
                                layout: 'hbox',
                                items: [
                                    {
                                        xtype: 'selectfield',
                                        flex: 1,
                                        cls: 'small_textfield_cls',
                                        itemId: 'WAREHOUSESelectField',
                                        inputCls: 'small_select_input',
                                        displayField: 'key',
                                        store: 'WAREHOUSEJsonStore',
                                        usePicker: false,
                                        valueField: 'nextField',
                                        listeners: [
                                            {
                                                fn: function(component, eOpts) {
                                                },
                                                event: 'initialize'
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        xtype: 'container',
                        flex: 1,
                        width: '32%',
                        layout: {
                            type: 'hbox',
                            align: 'center',
                            pack: 'center'
                        },
                        items: [
                            {
                                xtype: 'container',
                                cls: 'blue_font',
                                html: '跨',
                                margin: '0 5'
                            },
                            {
                                xtype: 'container',
                                flex: 1,
                                baseCls: 'blue_border',
                                items: [
                                    {
                                        xtype: 'selectfield',
                                        cls: 'small_textfield_cls',
                                        itemId: 'WAREHOUSE_HALLSelectField',
                                        inputCls: 'small_select_input',
                                        displayField: 'key',
                                        store: 'WAREHOUSE_HALLJsonStore',
                                        usePicker: false
                                    }
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                xtype: 'container',
                margin: '5 0',
                width: '100%',
                layout: 'hbox',
                items: [
                    {
                        xtype: 'container',
                        width: '50%',
                        layout: {
                            type: 'hbox',
                            align: 'center',
                            pack: 'center'
                        },
                        items: [
                            {
                                xtype: 'container',
                                cls: 'blue_font',
                                html: '区',
                                margin: '0 5'
                            },
                            {
                                xtype: 'container',
                                flex: 1,
                                baseCls: 'blue_border',
                                items: [
                                    {
                                        xtype: 'selectfield',
                                        cls: 'small_textfield_cls',
                                        itemId: 'WAREHOUSE_HALL_ZONESelectField',
                                        inputCls: 'small_select_input',
                                        displayField: 'key',
                                        store: 'WAREHOUSE_HALL_ZONEJsonStore',
                                        usePicker: false
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        xtype: 'container',
                        flex: 1,
                        hidden: false,
                        width: '32%',
                        layout: {
                            type: 'hbox',
                            align: 'center',
                            pack: 'center'
                        },
                        items: [
                            {
                                xtype: 'container',
                                cls: 'blue_font',
                                html: '行',
                                margin: '0 5'
                            },
                            {
                                xtype: 'container',
                                flex: 1,
                                baseCls: 'blue_border',
                                items: [
                                    {
                                        xtype: 'numberfield',
                                        cls: 'small_textfield_cls',
                                        itemId: 'rowNumField',
                                        inputCls: 'small_select_input'
                                    }
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                xtype: 'container',
                width: '100%',
                layout: 'hbox',
                items: [
                    {
                        xtype: 'button',
                        cls: [
                            'base_font_family',
                            'menu_view_bg'
                        ],
                        height: 32,
                        itemId: 'search',
                        ui: 'small',
                        width: 60,
                        text: '查询'
                    },
                    {
                        xtype: 'button',
                        cls: [
                            'base_font_family',
                            'menu_view_bg'
                        ],
                        height: 32,
                        itemId: 'reset',
                        margin: '0 5',
                        ui: 'small',
                        width: 60,
                        text: '重置'
                    }
                ]
            },
            {
                xtype: 'container',
                margin: '5 0 0 0',
                width: '100%',
                layout: 'hbox',
                items: [
                    {
                        xtype: 'container',
                        flex: 3,
                        cls: [
                            'table_head',
                            'base_font_family'
                        ],
                        html: '垛位号'
                    },
                    {
                        xtype: 'container',
                        flex: 1,
                        cls: [
                            'table_head',
                            'base_font_family'
                        ],
                        html: '层'
                    }
                ]
            },
            {
                xtype: 'list',
                flex: 1,
                itemId: 'dataView',
                width: '100%',
                itemTpl: [
                    '<div style=" width:75%; text-align:center;float:left; ">{slotId}</div>',
                    '<div style=" width:25%; text-align:center;float:left; ">{layer}</div>'
                ],
                store: 'TargetSelectStore',
                plugins: [
                    {
                        autoPaging: true,
                        loadMoreText: '加载更多',
                        noMoreRecordsText: '没有更多库位',
                        type: 'listpaging'
                    }
                ]
            }
        ],
        listeners: [
            {
                fn: 'onCloseTap',
                event: 'tap',
                delegate: '#close'
            },
            {
                fn: 'onWAREHOUSESelectFieldChange',
                event: 'change',
                delegate: '#WAREHOUSESelectField'
            },
            {
                fn: 'onWAREHOUSE_HALLSelectFieldChange',
                event: 'change',
                delegate: '#WAREHOUSE_HALLSelectField'
            },
            {
                fn: 'onSearchTap',
                event: 'tap',
                delegate: '#search'
            },
            {
                fn: 'onResetTap',
                event: 'tap',
                delegate: '#reset'
            },
            {
                fn: 'onDataViewItemTap',
                event: 'itemtap',
                delegate: '#dataView'
            },
            {
                fn: 'onTargetSelectDialogHide',
                event: 'hide'
            },
            {
                fn: 'onTargetSelectDialogInitialize',
                event: 'initialize'
            }
        ]
    },

    onCloseTap: function(button, e, eOpts) {
        // button.up('#targetSelectDialog').destroy();
        button.up('#targetSelectDialog').hide();
    },

    /**
     * 库改变事件
     * @param selectfield
     * @param newValue
     * @param oldValue
     * @param eOpts
     */
    onWAREHOUSESelectFieldChange: function(selectfield, newValue, oldValue, eOpts) {
        var WAREHOUSE_HALLJsonStore = Ext.getStore('WAREHOUSE_HALLJsonStore');
        WAREHOUSE_HALLJsonStore.removeAll();
        WAREHOUSE_HALLJsonStore.setParams({
            tableName: 'PES_WTM_HALL',
            displayField: 'HALL_NAME',
            valueField:'SID',
            filterName : 'WAREHOUSE_SID',
            filterValue : newValue
        });
        WAREHOUSE_HALLJsonStore.load({
            callback:function(){

            }
        });
    },

    /**
     * 跨改变事件
     * @param selectfield
     * @param newValue
     * @param oldValue
     * @param eOpts
     */
    onWAREHOUSE_HALLSelectFieldChange: function(selectfield, newValue, oldValue, eOpts) {
        var WAREHOUSE_HALL_ZONEJsonStore = Ext.getStore('WAREHOUSE_HALL_ZONEJsonStore');
        WAREHOUSE_HALL_ZONEJsonStore.removeAll();
        WAREHOUSE_HALL_ZONEJsonStore.setParams({
            tableName: 'PES_WTM_ZONE',
            displayField: 'ZONE_NAME',
            valueField:'SID',
            filterName : 'HALL_SID',
            filterValue : newValue
        });
        WAREHOUSE_HALL_ZONEJsonStore.load({
            callback:function(){
            }
        });
    },

    onSearchTap: function(button, e, eOpts) {
        var dialog = button.up('#targetSelectDialog');
        var dataview = dialog.down('#dataView');
        var store = dataview.getStore();//.load();
        var WAREHOUSESelectField = dialog.down('#WAREHOUSESelectField');
        var WAREHOUSE_HALLSelectField = dialog.down('#WAREHOUSE_HALLSelectField');
        var WAREHOUSE_HALL_ZONESelectField = dialog.down('#WAREHOUSE_HALL_ZONESelectField');
        var rowNum = dialog.down('#rowNumField').getValue();

        if (isNaN(rowNum)) {
            if (Ext.os.is('Android')) {
                window.plugins.toast.show('行号只能为数字！', 'long', 'center',
                                          function(a){console.log('toast success: ' + a);},
                                          function(b){console.log('toast error: ' + b);});
            } else {
                Ext.Msg.alert('错误','行号只能为数字！',Ext.emptyFn);
            }
        } else {
            store.setParams({
                'qm.warehouseSid' : WAREHOUSESelectField.getValue(),
                'qm.hallSid' : WAREHOUSE_HALLSelectField.getValue(),
                'qm.zoneSid' : WAREHOUSE_HALL_ZONESelectField.getValue(),
                'qm.rowNo' : rowNum
            });
            store.loadPage(1);
            var currentView = button.up('#targetSelectDialog');
            var WAREHOUSESelectField = currentView.down('#WAREHOUSESelectField');
            var WAREHOUSE_HALLSelectField = currentView.down('#WAREHOUSE_HALLSelectField');
            var WAREHOUSE_HALL_ZONESelectField = currentView.down('#WAREHOUSE_HALL_ZONESelectField');
            var result = {
                WAREHOUSESelectField:WAREHOUSESelectField.getValue(),
                WAREHOUSE_HALLSelectField:WAREHOUSE_HALLSelectField.getValue(),
                WAREHOUSE_HALL_ZONESelectField:WAREHOUSE_HALL_ZONESelectField.getValue()
            };
            var resultStr = Ext.encode(result);
            localStorage.WAREHOUSE = resultStr;
            console.log('WAREHOUSE = '+localStorage.WAREHOUSE);
            var rowNumField = currentView.down('#rowNumField');
            localStorage.rowNum = rowNumField.getValue();
        }

    },

    onResetTap: function(button, e, eOpts) {
        var dialog = button.up('#targetSelectDialog');
        var store = dialog.down('#dataView').getStore();//.load();
        var WAREHOUSESelectField = dialog.down('#WAREHOUSESelectField');
        var WAREHOUSE_HALLSelectField = dialog.down('#WAREHOUSE_HALLSelectField');
        var WAREHOUSE_HALL_ZONESelectField = dialog.down('#WAREHOUSE_HALL_ZONESelectField');
        console.log(WAREHOUSESelectField.getValue()+
                    ','+WAREHOUSE_HALLSelectField.getValue()+
                    ','+WAREHOUSE_HALL_ZONESelectField.getValue());
        store.setParams({
        //     WAREHOUSE_ID:WAREHOUSESelectField.getValue(),
            'qm.hallId':WAREHOUSE_HALLSelectField.getValue(),
            'qm.zoneId':WAREHOUSE_HALL_ZONESelectField.getValue()
        });
        store.removeAll();
        // console.log(store);
    },

    onDataViewItemTap: function(dataview, index, target, record, e, eOpts) {
        var targetSelectDialog = dataview.up('#targetSelectDialog');
        var func = targetSelectDialog.getCallback();
        func(record.get('slotId'),record.get('slotSid'),record.get('layer'),record.get('stateIn'));
        // dataview.up('#targetSelectDialog').destroy();
        dataview.up('#targetSelectDialog').hide();
    },

    onTargetSelectDialogHide: function(component, eOpts) {
        // console.log('targetSelect hide');
        // var store = component.down('#dataView').getStore();
        // store.removeAll();
        // store.setParams({});
        // component.destroy();
    },

    onTargetSelectDialogInitialize: function(component, eOpts) {
        // Ext.getStore('WAREHOUSEJsonStore').load({
        //     callback:function(){


        //     }
        // });
        // var store = component.down('#dataView').getStore();
        // store.removeAll();

        // var str = localStorage.WAREHOUSE;
        // var obj = Ext.decode(str);
        // var currentView = Ext.getCmp('targetSelectDialog');
        // if (obj) {
        //     //             console.log('WAREHOUSESelectField = '+obj.WAREHOUSESelectField);
        //     //             console.log('WAREHOUSE_HALLSelectField = '+obj.WAREHOUSE_HALLSelectField);
        //     //             console.log('WAREHOUSE_HALL_ZONESelectField = '+obj.WAREHOUSE_HALL_ZONESelectField);
        // //     console.log('targetSelectDialog = ',currentView);
        //     currentView.down('#WAREHOUSESelectField').setValue(obj.WAREHOUSESelectField);
        // }
        // if (localStorage.rowNum) {
        //     var rowNumField = currentView.down('#rowNumField');
        //     rowNumField.setValue(localStorage.rowNum);
        // }
        // if (localStorage.locationNo) {
        //     var locationNoField = currentView.down('#locationNoField');
        //     locationNoField.setValue(localStorage.locationNo);
        // }
    }

});